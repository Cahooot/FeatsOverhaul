// ==================================== Vanilla Defensive Duellist ====================================

// Change name of passive to "Duellist: Defence" and have it also unlock the spell to remove Versatile property from your weapon (under this passive as it doesn't have any BoostConditions)
new entry "DefensiveDuelist"
type "PassiveData"
data "DisplayName" "h830c8c3da7604a92892ae9328d498af54a43;1"
data "Description" "h512fdfb8g0895g47beg8807gac20c01cbff7;2"
data "DescriptionParams" "ProficiencyBonus"
data "TooltipUseCosts" "ReactionActionPoint:1"
data "Icon" "PassiveFeature_DefensiveDualist"
data "PriorityOrder" "3"
data "Properties" "Highlighted"
data "Boosts" "UnlockInterrupt(Interrupt_DefensiveDuelist);Ability(Dexterity,1);UnlockSpell(CHT_Duelist_RemoveVersatile)"

// Allow using Defensive Duellist interrupt while invisible 
new entry "Interrupt_DefensiveDuelist"
type "InterruptData"
using "Interrupt_DefensiveDuelist"
// Defensive Duellist
// data "DisplayName" "h30c13848ga882g4694g80ceg12693886a1c2;1"
// When attacked with a melee attack, add your &lt;LSTag Tooltip="ProficiencyBonus"&gt;Proficiency Bonus&lt;/LSTag&gt; to your &lt;LSTag Tooltip="ArmourClass"&gt;Armour Class&lt;/LSTag&gt;, possibly causing attacks to miss.
// data "Description" "h02446f84g87f6g49b1g919bged15f84c0e66;4"
// data "DescriptionParams" "ProficiencyBonus"
// Requires a &lt;LSTag Tooltip="Finesse"&gt;Finesse Weapon&lt;/LSTag&gt; you are &lt;LSTag Tooltip="Proficiency"&gt;Proficient&lt;/LSTag&gt; in.
// data "ExtraDescription" "hfd7efab4gf066g4701gb7acg29e669b2e875;1"
// data "Icon" "PassiveFeature_DefensiveDualist"
// data "InterruptContext" "OnPostRoll"
// data "InterruptContextScope" "Self"
// data "Container" "YesNoDecision"
// data "Conditions" "IsAbleToReact(context.Observer) and HasInterruptedAttack() and Self(context.Target,context.Observer) and not AnyEntityIsItem() and IsMeleeAttack() and HasWeaponProperty(WeaponProperties.Finesse, GetActiveWeapon(context.Observer)) and IsProficientWith(context.Observer, GetActiveWeapon(context.Observer)) and IsFlatValueInterruptInteresting(context.Observer.ProficiencyBonus, context.Source)"
data "Conditions" "(Player(context.Observer) or not HasStatus('SG_Invisible',context.Observer)) and IsAbleToReact(context.Observer) and HasInterruptedAttack() and Self(context.Target,context.Observer) and not AnyEntityIsItem() and IsMeleeAttack() and HasWeaponProperty(WeaponProperties.Finesse, GetActiveWeapon(context.Observer)) and IsProficientWith(context.Observer, GetActiveWeapon(context.Observer)) and IsFlatValueInterruptInteresting(context.Observer.ProficiencyBonus, context.Source)"
// data "Properties" "AdjustRoll(OBSERVER_OBSERVER,0-ProficiencyBonus);ApplyStatus(SWAP,PASSIVE_DEFENSIVE_DUELIST,100,0);ApplyStatus(OBSERVER_OBSERVER,INTERRUPT_DEFENSIVE_DUELIST,100,0)"
// data "Cost" "ReactionActionPoint:1"
// data "InterruptDefaultValue" "Enabled"
data "EnableCondition" "(not HasStatus('SG_Polymorph') or Goon_IsUnrestrictedPolymorphStatus()) and WieldingFinesseWeaponInSpecificHand(context.Source, false)"
// data "EnableContext" "OnStatusApplied;OnStatusRemoved"
data "EnableContext" "OnStatusApplied;OnStatusRemoved;OnEquip"
data "InterruptFlags" "InterruptWhileInvisible"

// ==================================== New Duellist: Precision passive ====================================

// New passive for when equipping a Finesse weapon in one hand with off-hand empty
new entry "DefensiveDuelist_Precision"
type "PassiveData"
data "DisplayName" "h79a678f01ae64219b238623f25128313ae45;1"
data "Description" "ha08ee9a5976a401a9d9ea09d0564bd55ac5c;1"
data "DescriptionParams" "1"
data "Icon" "PassiveFeature_FightingStyle_Duelling"
data "PriorityOrder" "2"
data "Properties" "Highlighted"
data "BoostContext" "OnCreate;OnEquip"
data "BoostConditions" "HasWeaponProperty(WeaponProperties.Finesse, GetActiveWeapon(context.Observer)) and not HasWeaponProperty(WeaponProperties.Versatile, GetActiveWeapon(context.Observer)) and IsProficientWith(context.Observer, GetActiveWeapon(context.Observer)) and IsOffHandSlotEmpty()"
data "Boosts" "RollBonus(MeleeWeaponAttack, ProficiencyBonus);IF(IsMeleeWeaponAttack()):ReduceCriticalAttackThreshold(1)"

// ==================================== New spell to remove Versatile property ====================================

// New spell given to remove Versatile property from a Versatile + Finesse weapon (so it can be used with the new Duellist: Precision passive)
new entry "CHT_Duelist_RemoveVersatile"
type "SpellData"
data "SpellType" "Shout"
data "Level" "0"
data "SpellProperties" "IF(CHT_DuelistCheck(GetItemInEquipmentSlot(EquipmentSlot.MeleeMainHand))):ApplyEquipmentStatus(MeleeMainHand, CHT_DUELIST_REMOVED_VERSATILE, 100, -1);IF(not HasStatus('CHT_DUELIST_REMOVEVERSATILE_HELPER')):ApplyStatus(SELF,CHT_DUELIST_REMOVED_VERSATILE_HELPER,100,-1)"
data "TargetConditions" "Self()"
data "Icon" "PassiveFeature_DefensiveDualist"
data "DisplayName" "h7bb30c90ge822g41ebg8191gad878262e9b5;1"
data "Description" "h0466eef8g6a5ag45cfg95aagb91fe4ad08ca;1"
data "TooltipStatusApply" "ApplyStatus(CHT_DUELIST_REMOVED_VERSATILE, 100, -1)"
data "PrepareSound" "Spell_Prepare_Buff_Gen_L1to3_01"
data "PrepareLoopSound" "Spell_Prepare_Buff_Gen_L1to3_01_Loop"
data "CastSound" "Spell_Cast_Buff_MagicWeapon_L1to3"
data "TargetSound" "Spell_Impact_Buff_MagicWeapon_L1to3"
data "VocalComponentSound" "Vocal_Component_EnchantWeapon"
data "CastTextEvent" "Cast"
data "SpellAnimation" "8b8bb757-21ce-4e02-a2f3-97d55cf2f90b,,;,,;35b644cf-5c13-4407-9dc1-23bf4309216e,,;823e3ddf-c670-41ef-b7b4-9f4a4e38300b,,;7bb52cd4-0b1c-4926-9165-fa92b75876a3,,;,,;0b07883a-08b8-43b6-ac18-84dc9e84ff50,,;,,;,,"
data "VerbalIntent" "Buff"
data "WeaponTypes" "Melee"
data "SpellFlags" "HasVerbalComponent;IsMelee;HasSomaticComponent"
data "SpellAnimationIntentType" "Aggressive"
data "RequirementConditions" "CHT_NotBalancedWeaponActive(context.Source) and CHT_NotBalancedWeapon(GetItemInEquipmentSlot(EquipmentSlot.MeleeMainHand)) and CHT_DuelistCheck(GetItemInEquipmentSlot(EquipmentSlot.MeleeMainHand))"
data "RequirementEvents" "OnEquip;OnUnequip"
data "PrepareEffect" "33302a46-4a12-41dd-8845-6b7314d50022"
data "CastEffect" "bcd66fb0-b0bc-41d0-abba-ad443d63dd72"
data "Sheathing" "Melee"

// Status applied to character (to give the cancel spell)
new entry "CHT_DUELIST_REMOVED_VERSATILE_HELPER"
type "StatusData"
data "StatusType" "BOOST"
data "StackId" "CHT_DUELIST_REMOVED_VERSATILE_HELPER"
data "Passives" "CHT_Duelist_RemoveVersatile_Cancel_Passive"
data "StatusPropertyFlags" "DisableOverhead;DisableCombatlog;DisablePortraitIndicator"

// Status applied to weapon (triggers the actual effect through SE)
new entry "CHT_DUELIST_REMOVED_VERSATILE"
type "StatusData"
data "StatusType" "BOOST"
data "DisplayName" "hb023c5d2g8817g4c47g9a20g2515b5a4caac;1"
data "Description" "h93059cd3gb9bfg4082gbba2g3957ed6db4b0;1"
data "Icon" "PassiveFeature_DefensiveDualist"
data "StackId" "CHT_DUELIST_REMOVED_VERSATILE"
data "StackPriority" "0"
data "Boosts" "Attribute(InventoryBound)"
data "StatusGroups" "SG_RemoveOnRespec"
data "RemoveEvents" "OnStatusApplied"
data "RemoveConditions" "StatusId('CHT_DUELIST_REMOVED_VERSATILE_CANCEL_HELPER')"

// Spell to remove the original "Remove Versatile Property" status after it's applied
new entry "CHT_Duelist_RemoveVersatile_Cancel_Passive"
type "PassiveData"
data "Properties" "IsHidden"
data "BoostContext" "OnStatusApply;OnStatusRemove;OnEquip;OnCreate;OnInventoryChanged;OnCast;OnMovedDistance"
data "BoostConditions" "HasStatus('CHT_DUELIST_REMOVED_VERSATILE',GetItemInEquipmentSlot(EquipmentSlot.MeleeMainHand))"
data "Boosts" "UnlockSpell(CHT_Duelist_RemoveVersatile_Cancel)"

new entry "CHT_Duelist_RemoveVersatile_Cancel"
type "SpellData"
data "SpellType" "Shout"
using "CHT_Duelist_RemoveVersatile"
data "SpellProperties" "RemoveStatus(SELF,CHT_DUELIST_REMOVED_VERSATILE_HELPER);ApplyEquipmentStatus(MeleeMainHand, CHT_DUELIST_REMOVED_VERSATILE_CANCEL_HELPER, 100, 0)"
data "DisplayName" "h1d3aee54g050fg41d3gb64dg1e4d0f0f72a2;1"
data "Description" "h7df13240gd0ffg4d1bgb37dgf7fbb42ca067;1"
data "TooltipStatusApply" ""
data "CastSound" "Spell_Cast_Buff_ProtectionFromEvilAndGood_L1to3"
data "TargetSound" "Spell_Impact_Buff_ProtectionFromEvilAndGood_L1to3"
data "SpellFlags" "Temporary"
data "SpellAnimationIntentType" "Peaceful"
data "VocalComponentSound" ""
data "UseCosts" ""
data "TargetEffect" "676c75da-d477-4230-83fc-dae283c67ee1"
data "RequirementConditions" "CHT_IsBalancedWeapon(GetItemInEquipmentSlot(EquipmentSlot.MeleeMainHand))"
data "Sheathing" "Melee"

// Helper status that removes CHT_DUELIST_REMOVED_VERSATILE when applied to the weapon
new entry "CHT_DUELIST_REMOVED_VERSATILE_CANCEL_HELPER"
type "StatusData"
data "StatusType" "BOOST"
data "StackId" "CHT_DUELIST_REMOVED_VERSATILE_CANCEL_HELPER"
data "StatusPropertyFlags" "DisableOverhead;DisableCombatlog;DisablePortraitIndicator"

